<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-NF9GJK3L2R"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-NF9GJK3L2R');
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout — Spun</title>
  <meta name="description" content="Complete your Spun AI agent purchase with Solana Pay." />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0a0a0a; --bg2: #111111; --bg3: #1a1a1a; --border: #2a2a2a;
      --text: #f0f0f0; --muted: #888; --accent: #9945ff; --green: #14f195;
    }
    body {
      background: var(--bg); color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height: 1.6; min-height: 100vh;
    }
    a { color: var(--green); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* Nav */
    nav {
      padding: 20px 24px; display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid var(--border); position: sticky; top: 0;
      background: rgba(10,10,10,0.95); backdrop-filter: blur(10px); z-index: 100;
    }
    .logo {
      font-size: 20px; font-weight: 800; letter-spacing: -0.5px;
      background: linear-gradient(135deg, var(--accent), var(--green));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      text-decoration: none;
    }

    /* Card */
    .checkout-wrap {
      max-width: 480px; margin: 40px auto; padding: 0 24px 80px;
    }
    .card {
      background: var(--bg2); border: 1px solid var(--border);
      border-radius: 16px; padding: 32px 24px; text-align: center;
    }

    /* Loading state */
    .spinner {
      width: 40px; height: 40px; border: 3px solid var(--border);
      border-top-color: var(--accent); border-radius: 50%;
      animation: spin 0.8s linear infinite; margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Payment state */
    .ref-badge {
      display: inline-block; background: rgba(20,241,149,0.12);
      border: 1px solid rgba(20,241,149,0.3); color: var(--green);
      font-size: 13px; font-weight: 600; padding: 5px 14px;
      border-radius: 100px; margin-bottom: 16px;
    }
    .card h2 { font-size: 22px; font-weight: 900; margin-bottom: 8px; }
    .sol-amount {
      font-size: 42px; font-weight: 900; line-height: 1;
      background: linear-gradient(135deg, var(--accent), var(--green));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      margin: 16px 0 4px;
    }
    .usd-note { font-size: 14px; color: var(--muted); margin-bottom: 24px; }
    #qrcode {
      display: flex; justify-content: center; margin-bottom: 20px;
    }
    #qrcode canvas { border-radius: 8px; }
    .wallet-btn {
      display: block; width: 100%; padding: 14px; margin-bottom: 16px;
      background: linear-gradient(135deg, var(--accent), #7b2fe0);
      color: white; border: none; border-radius: 10px; font-size: 16px;
      font-weight: 700; cursor: pointer; text-align: center; text-decoration: none;
      transition: opacity 0.2s;
    }
    .wallet-btn:hover { opacity: 0.85; text-decoration: none; }
    .wallet-hint { font-size: 13px; color: var(--muted); margin-bottom: 20px; }
    .waiting {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      padding: 16px 0 0; border-top: 1px solid var(--border);
      font-size: 14px; color: var(--muted);
    }
    .dots::after {
      content: ''; animation: dots 1.5s steps(4, end) infinite;
    }
    @keyframes dots {
      0% { content: ''; } 25% { content: '.'; } 50% { content: '..'; } 75% { content: '...'; }
    }

    /* Confirmed state */
    .check-icon {
      width: 64px; height: 64px; border-radius: 50%;
      background: rgba(20,241,149,0.15); border: 2px solid var(--green);
      display: flex; align-items: center; justify-content: center;
      font-size: 28px; margin: 0 auto 20px;
    }
    .install-box {
      background: #0d0d0d; border: 1px solid var(--border);
      border-radius: 12px; padding: 16px 20px; text-align: left; margin: 20px 0;
    }
    .install-label {
      font-size: 12px; color: var(--muted); font-weight: 600;
      letter-spacing: 1px; text-transform: uppercase; margin-bottom: 10px;
    }
    .install-cmd {
      font-family: 'SF Mono', 'Fira Code', monospace; font-size: 14px;
      color: var(--green); word-break: break-all; line-height: 1.5;
    }
    .copy-btn {
      display: block; width: 100%; padding: 12px;
      background: rgba(153,69,255,0.15); border: 1px solid var(--accent);
      color: var(--accent); border-radius: 8px; font-size: 14px;
      font-weight: 600; cursor: pointer; margin-top: 10px; transition: background 0.2s;
    }
    .copy-btn:hover { background: rgba(153,69,255,0.25); }

    .steps-mini { text-align: left; margin: 20px 0; }
    .steps-mini h3 { font-size: 15px; font-weight: 700; margin-bottom: 10px; }
    .step-mini {
      display: flex; gap: 12px; padding: 8px 0;
      border-bottom: 1px solid var(--border); font-size: 14px;
    }
    .step-mini:last-child { border-bottom: none; }
    .step-n { color: var(--accent); font-weight: 700; flex-shrink: 0; }
    .step-t { color: var(--muted); }

    /* Share section */
    .share-section {
      margin-top: 24px; padding-top: 24px;
      border-top: 1px solid var(--border); text-align: left;
    }
    .share-section h3 { font-size: 16px; font-weight: 700; margin-bottom: 6px; }
    .share-section p { font-size: 13px; color: var(--muted); margin-bottom: 14px; }
    .share-input-wrap {
      display: flex; gap: 8px; margin-bottom: 10px;
    }
    .share-input {
      flex: 1; background: var(--bg); border: 1px solid var(--border);
      border-radius: 8px; padding: 10px 12px; color: var(--text);
      font-size: 13px; font-family: 'SF Mono', 'Fira Code', monospace;
    }
    .share-copy-btn {
      background: var(--accent); color: white; border: none; border-radius: 8px;
      padding: 10px 16px; font-size: 13px; font-weight: 700; cursor: pointer;
      white-space: nowrap;
    }
    .x-share-btn {
      display: block; text-align: center; padding: 10px;
      background: rgba(153,69,255,0.1); border: 1px solid var(--border);
      border-radius: 8px; font-size: 13px; color: var(--text);
      text-decoration: none; font-weight: 600;
    }
    .x-share-btn:hover { background: rgba(153,69,255,0.2); text-decoration: none; }
    .share-note { font-size: 12px; color: var(--muted); margin-top: 10px; }

    .hidden { display: none !important; }
  </style>
</head>
<body>

  <nav>
    <a href="/" class="logo">spun</a>
  </nav>

  <div class="checkout-wrap">
    <!-- STATE 1: Loading -->
    <div class="card" id="state-loading">
      <div class="spinner"></div>
      <p style="color:var(--muted);">Preparing your checkout...</p>
    </div>

    <!-- STATE 2: Payment pending -->
    <div class="card hidden" id="state-payment">
      <div id="ref-badge-wrap"></div>
      <h2>Complete Your Purchase</h2>
      <div class="sol-amount" id="sol-amount"></div>
      <div class="usd-note">&asymp; $125 USD</div>
      <div id="qrcode"></div>
      <a id="wallet-link" class="wallet-btn" href="#">Open in Wallet</a>
      <p class="wallet-hint">Scan with Phantom, Solflare, or any Solana wallet</p>
      <div class="waiting">
        <span>Waiting for payment</span><span class="dots"></span>
      </div>
    </div>

    <!-- STATE 3: Confirmed -->
    <div class="card hidden" id="state-confirmed">
      <div class="check-icon">&#10003;</div>
      <h2>Payment confirmed!</h2>
      <p style="color:var(--muted);font-size:15px;margin-bottom:4px;">You're one command away from your AI agent.</p>

      <div class="install-box">
        <div class="install-label">Your install command</div>
        <div class="install-cmd" id="install-cmd"></div>
        <button class="copy-btn" onclick="copyInstall()">Copy Command</button>
      </div>

      <div class="steps-mini">
        <h3>What to do now:</h3>
        <div class="step-mini"><span class="step-n">1.</span><span class="step-t">Open <strong>Terminal</strong> on your Mac</span></div>
        <div class="step-mini"><span class="step-n">2.</span><span class="step-t">Paste the command and hit <strong>Enter</strong></span></div>
        <div class="step-mini"><span class="step-n">3.</span><span class="step-t">Log into <strong>Claude.ai</strong> when prompted</span></div>
        <div class="step-mini"><span class="step-n">4.</span><span class="step-t">Done. Your agent is live.</span></div>
      </div>

      <div class="share-section">
        <h3>Share &amp; Earn $25</h3>
        <p>Get your personal referral link from <a href="https://t.me/spunsupport_bot" style="color:var(--green);">@spunsupport_bot</a> &mdash; earn $25 in SOL for every person who sets up through your link.</p>
        <div class="share-input-wrap">
          <input class="share-input" id="share-link" readonly />
          <button class="share-copy-btn" onclick="copyShareLink()">Copy</button>
        </div>
        <a id="x-share" class="x-share-btn" href="#" target="_blank" rel="noopener">Share on X</a>
        <p class="share-note">DM <a href="https://t.me/spunsupport_bot" style="color:var(--accent);">@spunsupport_bot</a> on Telegram to get your official referral code.</p>
      </div>
    </div>
  </div>

  <script>
    (function() {
      var RECIPIENT = 'FN74faeP6NUnUqtFwohKKQzbWLbbWjJf3Dw5LGPe1gDt';
      var INSTALL_CMD = 'curl -fsSL https://raw.githubusercontent.com/sandwormmr-eng/spun/main/install.sh | bash';
      var TRACKER_URL = 'https://spun-tracker.REPLACE_ME.workers.dev'; // update after CF deploy
      var pollTimer = null;
      var referenceKey = null;
      var solAmountGlobal = null;

      // Read ref from URL or localStorage
      var params = new URLSearchParams(window.location.search);
      var ref = params.get('ref') || localStorage.getItem('spun_ref') || null;
      if (ref) localStorage.setItem('spun_ref', ref);

      init();

      // ── Base58 encoder (for Solana reference key) ─────────────────────────
      function base58Encode(bytes) {
        var ALPHA = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
        var hex = Array.from(bytes).map(function(b) { return b.toString(16).padStart(2, '0'); }).join('');
        var n = BigInt('0x' + hex);
        var result = '';
        while (n > 0n) { result = ALPHA[Number(n % 58n)] + result; n = n / 58n; }
        for (var i = 0; i < bytes.length && bytes[i] === 0; i++) result = '1' + result;
        return result;
      }

      // ── Init: fetch SOL price + build checkout ────────────────────────────
      async function init() {
        try {
          // Fetch live SOL price
          var priceRes = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd');
          var priceData = await priceRes.json();
          var solPrice = priceData.solana.usd;
          var solAmount = (125 / solPrice).toFixed(4);
          solAmountGlobal = solAmount;

          // Generate a random reference key (32 bytes → base58 pubkey)
          var randomBytes = new Uint8Array(32);
          crypto.getRandomValues(randomBytes);
          referenceKey = base58Encode(randomBytes);

          showPayment(solAmount);
        } catch (err) {
          document.getElementById('state-loading').innerHTML =
            '<p style="color:#ff5f56;font-size:15px;">Failed to load checkout. Please refresh.</p>' +
            '<p style="color:var(--muted);font-size:13px;margin-top:8px;">If this keeps happening, message <a href="https://t.me/spunsupport_bot" style="color:var(--green);">@spunsupport_bot</a></p>';
        }
      }

      // ── Show the payment QR ───────────────────────────────────────────────
      function showPayment(solAmount) {
        document.getElementById('state-loading').classList.add('hidden');
        document.getElementById('state-payment').classList.remove('hidden');

        // Ref badge
        if (ref) {
          document.getElementById('ref-badge-wrap').innerHTML =
            '<div class="ref-badge">Referred by ' + escapeHtml(ref) + '</div>';
        }

        document.getElementById('sol-amount').textContent = solAmount + ' SOL';

        // Build Solana Pay URL
        var payUrl = 'solana:' + RECIPIENT +
          '?amount=' + solAmount +
          '&reference=' + referenceKey +
          '&label=Spun' +
          '&message=Spun%20Setup%20-%20%24125';

        // Render QR code
        new QRCode(document.getElementById('qrcode'), {
          text: payUrl,
          width: 200,
          height: 200,
          colorDark: '#ffffff',
          colorLight: '#111111',
          correctLevel: QRCode.CorrectLevel.M
        });

        document.getElementById('wallet-link').href = payUrl;

        // GA4 begin_checkout event
        if (typeof gtag !== 'undefined') {
          gtag('event', 'begin_checkout', {
            value: 125, currency: 'USD',
            items: [{ item_id: 'spun_setup', item_name: 'Spun AI Agent Setup', price: 125, quantity: 1 }]
          });
        }

        // Poll Solana mainnet RPC directly
        pollTimer = setInterval(function() { checkPaymentOnChain(); }, 4000);
      }

      // ── Poll Solana RPC for the reference key ─────────────────────────────
      async function checkPaymentOnChain() {
        try {
          var rpcRes = await fetch('https://api.mainnet-beta.solana.com', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              jsonrpc: '2.0', id: 1,
              method: 'getSignaturesForAddress',
              params: [referenceKey, { limit: 1 }]
            })
          });
          var rpcData = await rpcRes.json();
          if (rpcData.result && rpcData.result.length > 0) {
            clearInterval(pollTimer);
            var txHash = rpcData.result[0].signature || '';
            showConfirmed(txHash);
          }
        } catch (err) {
          // silently retry on next tick
        }
      }

      // ── Payment confirmed ─────────────────────────────────────────────────
      function showConfirmed(txHash) {
        document.getElementById('state-payment').classList.add('hidden');
        document.getElementById('state-confirmed').classList.remove('hidden');
        document.getElementById('install-cmd').textContent = INSTALL_CMD;

        // GA4 purchase event
        if (typeof gtag !== 'undefined') {
          gtag('event', 'purchase', {
            transaction_id: txHash || referenceKey,
            value: 125,
            currency: 'USD',
            items: [{ item_id: 'spun_setup', item_name: 'Spun AI Agent Setup', price: 125, quantity: 1 }]
          });
        }

        // Ping tracker if a referral code was present
        if (ref && TRACKER_URL && !TRACKER_URL.includes('REPLACE_ME')) {
          fetch(TRACKER_URL + '/conversion', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ref: ref, txHash: txHash, solAmount: solAmountGlobal })
          }).catch(function() {}); // fire-and-forget, never block the UX
        }

        // Pre-fill referral link if they have a ref code in storage
        var myRef = localStorage.getItem('spun_ref');
        var shareUrl = myRef
          ? 'https://spun.sh?ref=' + encodeURIComponent(myRef)
          : 'https://spun.sh';
        document.getElementById('share-link').value = shareUrl;

        var tweet = encodeURIComponent('Just set up my AI agent with @spunsh in 15 min. One command. No coding required.\n\n' + shareUrl);
        document.getElementById('x-share').href = 'https://x.com/intent/tweet?text=' + tweet;
      }

      function escapeHtml(str) {
        var d = document.createElement('div');
        d.appendChild(document.createTextNode(str));
        return d.innerHTML;
      }

      window.copyInstall = function() {
        navigator.clipboard.writeText(INSTALL_CMD).then(function() {
          var btn = document.querySelector('.copy-btn');
          btn.textContent = 'Copied!';
          setTimeout(function() { btn.textContent = 'Copy Command'; }, 2000);
        });
      };

      window.copyShareLink = function() {
        var val = document.getElementById('share-link').value;
        navigator.clipboard.writeText(val).then(function() {
          var btn = document.querySelector('.share-copy-btn');
          btn.textContent = 'Copied!';
          setTimeout(function() { btn.textContent = 'Copy'; }, 2000);
        });
      };
    })();
  </script>
</body>
</html>
